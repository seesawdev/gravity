@startuml
skinparam BackgroundColor #white
skinparam RoundCorner 20
skinparam note {
  BackgroundColor #yellow
}
skinparam sequence {
	ArrowColor DeepSkyBlue
	ActorBorderColor DeepSkyBlue
	LifeLineBorderColor blue
	LifeLineBackgroundColor #A9DCDF

	ParticipantBorderColor DeepSkyBlue
	ParticipantBackgroundColor DodgerBlue
	ParticipantFontName Consolas
	ParticipantFontSize 17
	ParticipantFontColor #A9DCDF

	ActorBackgroundColor aqua
	ActorFontColor DeepSkyBlue
	ActorFontSize 17
	ActorFontName Aapex
}

actor user
participant process as P
box systemd unit
participant driver as DP
participant "peer" as PP
participant "agent" as A
participant "wizard process" as W
end box
database "state database" as db order 100

title Joining a node during installation

user -> P : start
activate P
P -> P : prerequisites
note left
  # ensure no local state
  # validate configuration
  # execute local preflight checks
end note

== Initialization ==

P -> DP : start (if not yet running)
activate DP

DP -> db : create/read state\nfrom /usr/local/share/gravity/join
DP -> PP : init
activate PP
PP -> PP : bootstrap
note right
  # reset logins
  # log into peer
  # setup state directory
end note

DP -> PP : start
PP-> A : start
activate A
A -> W : connect
A -> A : prerequisites
note right
  # init service user/export binary
  # validate server profile
end note

== Execute Operation ==

A <-> W : accept remote commands
return done

DP -> PP : wait

return done
return done
return done

@enduml
